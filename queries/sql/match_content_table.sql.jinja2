CREATE OR REPLACE TABLE `{{ output_table_id }}` AS

WITH unique_works AS (
  SELECT DISTINCT match.dataset_doi AS doi
  FROM `{{ match_intermediate_table_id }}` AS matches, UNNEST(matches.matches) AS match
)

SELECT unique_works.doi, CONCAT(dataset.title, ' ', dataset.abstract) AS content
FROM unique_works
LEFT JOIN `{{ dataset_table_id }}` AS dataset ON dataset.doi = unique_works.doi